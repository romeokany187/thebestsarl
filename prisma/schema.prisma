generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
  ACCOUNTANT
}

enum JobTitle {
  COMMERCIAL
  COMPTABLE
  CAISSIERE
  RELATION_PUBLIQUE
  APPROVISIONNEMENT_MARKETING
  AGENT_TERRAIN
  DIRECTION_GENERALE
}

enum ReportPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ANNUAL
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  OFF
}

enum SiteType {
  OFFICE
  ASSIGNMENT
}

enum PresenceLocationStatus {
  OFFICE
  ASSIGNMENT
  OFFSITE
  UNKNOWN
}

enum PaymentStatus {
  PAID
  UNPAID
  PARTIAL
}

enum TravelClass {
  ECONOMY
  PREMIUM_ECONOMY
  BUSINESS
  FIRST
}

enum SaleNature {
  CASH
  CREDIT
}

enum CommissionMode {
  IMMEDIATE
  AFTER_DEPOSIT
  SYSTEM_PLUS_MARKUP
  MARKUP_ONLY
}

enum CommissionCalculationStatus {
  ESTIMATED
  FINAL
}

model Team {
  id        String   @id @default(cuid())
  name      String   @unique
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id            String        @id @default(cuid())
  name          String
  email         String        @unique
  passwordHash  String
  role          Role
  jobTitle      JobTitle      @default(AGENT_TERRAIN)
  teamId        String?
  team          Team?         @relation(fields: [teamId], references: [id])
  reports       WorkerReport[] @relation("ReportAuthor")
  approvals     WorkerReport[] @relation("ReportReviewer")
  attendances   Attendance[]
  ticketsSold   TicketSale[]  @relation("TicketSeller")
  logs          AuditLog[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model WorkerReport {
  id              String       @id @default(cuid())
  title           String
  content         String
  period          ReportPeriod
  periodStart     DateTime
  periodEnd       DateTime
  status          ReportStatus @default(DRAFT)
  authorId        String
  author          User         @relation("ReportAuthor", fields: [authorId], references: [id])
  reviewerId      String?
  reviewer        User?        @relation("ReportReviewer", fields: [reviewerId], references: [id])
  reviewerComment String?
  submittedAt     DateTime?
  approvedAt      DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Attendance {
  id             String           @id @default(cuid())
  userId         String
  user           User             @relation(fields: [userId], references: [id])
  date           DateTime
  clockIn        DateTime?
  clockOut       DateTime?
  signedAt       DateTime?
  status         AttendanceStatus @default(PRESENT)
  latenessMins   Int              @default(0)
  overtimeMins   Int              @default(0)
  signLatitude   Float?
  signLongitude  Float?
  signAccuracyM  Float?
  signAddress    String?
  locationStatus PresenceLocationStatus @default(UNKNOWN)
  matchedSiteId  String?
  matchedSite    WorkSite?        @relation(fields: [matchedSiteId], references: [id])
  matchDistanceM Float?
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([userId, date])
}

model WorkSite {
  id           String    @id @default(cuid())
  name         String
  type         SiteType
  latitude     Float
  longitude    Float
  radiusMeters Int       @default(150)
  isActive     Boolean   @default(true)
  attendances  Attendance[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Airline {
  id              String           @id @default(cuid())
  code            String           @unique
  name            String
  tickets         TicketSale[]
  commissionRules CommissionRule[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model CommissionRule {
  id          String   @id @default(cuid())
  airlineId   String
  airline     Airline  @relation(fields: [airlineId], references: [id])
  ratePercent Float
  routePattern String  @default("*")
  travelClass  TravelClass?
  commissionMode CommissionMode @default(IMMEDIATE)
  systemRatePercent Float @default(0)
  markupRatePercent Float @default(0)
  defaultBaseFareRatio Float @default(0.6)
  depositStockTargetAmount Float?
  depositStockConsumedAmount Float @default(0)
  batchCommissionAmount Float?
  startsAt    DateTime
  endsAt      DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TicketSale {
  id                 String        @id @default(cuid())
  ticketNumber       String        @unique
  customerName       String
  route              String
  travelClass        TravelClass   @default(ECONOMY)
  travelDate         DateTime
  soldAt             DateTime      @default(now())
  amount             Float
  baseFareAmount     Float?
  currency           String        @default("USD")
  airlineId          String
  airline            Airline       @relation(fields: [airlineId], references: [id])
  sellerId           String
  seller             User          @relation("TicketSeller", fields: [sellerId], references: [id])
  saleNature         SaleNature    @default(CASH)
  paymentStatus      PaymentStatus @default(UNPAID)
  payerName          String?
  agencyMarkupPercent Float        @default(0)
  agencyMarkupAmount Float         @default(0)
  commissionBaseAmount Float       @default(0)
  commissionCalculationStatus CommissionCalculationStatus @default(ESTIMATED)
  commissionRateUsed Float
  commissionAmount   Float         @default(0)
  commissionModeApplied CommissionMode @default(IMMEDIATE)
  notes              String?
  payments           Payment[]
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
}

model Payment {
  id          String    @id @default(cuid())
  ticketId    String
  ticket      TicketSale @relation(fields: [ticketId], references: [id])
  amount      Float
  paidAt      DateTime  @default(now())
  method      String
  reference   String?
  createdAt   DateTime  @default(now())
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String
  actor      User     @relation(fields: [actorId], references: [id])
  action     String
  entityType String
  entityId   String
  payload    Json?
  createdAt  DateTime @default(now())
}
